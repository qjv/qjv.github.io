<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GW2 Palette Mapping Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #0f1419;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        h1 {
            color: #ffd700;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .description {
            color: #a0aec0;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            background: #1a202c;
            border: 1px solid #2d3748;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .status.error {
            border-color: #f56565;
            background: #2d1f1f;
        }

        .status.success {
            border-color: #48bb78;
            background: #1f2d23;
        }

        .progress {
            margin-top: 0.5rem;
            height: 4px;
            background: #2d3748;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            width: 0%;
        }

        #output {
            background: #1a202c;
            border: 1px solid #2d3748;
            border-radius: 6px;
            padding: 1rem;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: #1a202c;
            border: 1px solid #2d3748;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            color: #ffd700;
            font-weight: bold;
        }

        .stat-label {
            color: #a0aec0;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .copy-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            margin-top: 1rem;
            width: 100%;
        }

        .copy-btn:hover {
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è GW2 Palette Mapping Generator</h1>
        <p class="description">
            This tool generates a complete palette ID to skill ID mapping by fetching data from the GW2 API.
            The generated mapping can be used to resolve palette IDs from build templates without making API calls.
        </p>

        <div class="controls">
            <button id="generateBtn" onclick="generateMapping()">Generate Mapping</button>
            <button id="downloadBtn" onclick="downloadMapping()" disabled>Download palette-mapping.js</button>
        </div>

        <div id="statusContainer" style="display: none;">
            <div class="status" id="status">Ready</div>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div id="statsContainer" style="display: none;">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalMappings">0</div>
                    <div class="stat-label">Total Mappings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="professionCount">0</div>
                    <div class="stat-label">Professions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fileSize">0 KB</div>
                    <div class="stat-label">File Size</div>
                </div>
            </div>
        </div>

        <div id="outputContainer" style="display: none;">
            <h3 style="margin-bottom: 1rem; color: #ffd700;">Generated Code Preview</h3>
            <div id="output"></div>
            <button class="copy-btn" onclick="copyToClipboard()">Copy to Clipboard</button>
        </div>
    </div>

    <script>
        let generatedCode = '';
        const API_BASE = 'https://api.guildwars2.com/v2';

        const professions = [
            'Guardian', 'Warrior', 'Engineer', 'Ranger',
            'Thief', 'Elementalist', 'Mesmer', 'Necromancer', 'Revenant'
        ];

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            const container = document.getElementById('statusContainer');

            container.style.display = 'block';
            status.textContent = message;
            status.className = 'status';

            if (type === 'error') {
                status.classList.add('error');
            } else if (type === 'success') {
                status.classList.add('success');
            }
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${percent}%`;
        }

        async function fetchProfessionMapping(professionName) {
            // Try multiple API schema versions
            const versions = ['latest', '2024-06-11', '2022-03-23', '2019-12-19'];

            for (const version of versions) {
                try {
                    const url = `${API_BASE}/professions/${professionName}?v=${version}&lang=en`;
                    const response = await fetch(url);

                    if (!response.ok) {
                        console.log(`Failed with v=${version}: HTTP ${response.status}`);
                        continue;
                    }

                    const data = await response.json();

                    if (data.skills_by_palette && data.skills_by_palette.length > 0) {
                        console.log(`‚úì ${professionName}: Found ${data.skills_by_palette.length} mappings using v=${version}`);
                        return data.skills_by_palette;
                    } else {
                        console.log(`‚úó ${professionName}: v=${version} has no skills_by_palette`);
                    }
                } catch (error) {
                    console.error(`Error with v=${version}:`, error);
                }
            }

            console.warn(`${professionName}: No version had skills_by_palette`);
            return [];
        }

        async function generateMapping() {
            const generateBtn = document.getElementById('generateBtn');
            const downloadBtn = document.getElementById('downloadBtn');

            generateBtn.disabled = true;
            downloadBtn.disabled = true;
            document.getElementById('outputContainer').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';

            updateStatus('Starting palette mapping generation...');
            updateProgress(0);

            try {
                const allMappings = {};
                let totalMappings = 0;

                for (let i = 0; i < professions.length; i++) {
                    const profession = professions[i];
                    updateStatus(`Fetching ${profession} palette mappings... (${i + 1}/${professions.length})`);
                    updateProgress(((i + 1) / professions.length) * 100);

                    try {
                        const mapping = await fetchProfessionMapping(profession);

                        // Add mappings to the combined object
                        mapping.forEach(([paletteId, skillId]) => {
                            if (paletteId > 0 && skillId > 0) {
                                // If palette ID already exists, keep the first one (or we could log duplicates)
                                if (!allMappings[paletteId]) {
                                    allMappings[paletteId] = skillId;
                                    totalMappings++;
                                }
                            }
                        });

                        console.log(`${profession}: ${mapping.length} palette mappings`);
                    } catch (error) {
                        console.error(`Failed to fetch ${profession}:`, error);
                        updateStatus(`Warning: Failed to fetch ${profession} (${error.message})`, 'error');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                // Generate the JavaScript code
                generatedCode = generateJavaScriptCode(allMappings);

                // Update UI
                document.getElementById('output').textContent = generatedCode;
                document.getElementById('outputContainer').style.display = 'block';
                document.getElementById('statsContainer').style.display = 'block';

                document.getElementById('totalMappings').textContent = totalMappings.toLocaleString();
                document.getElementById('professionCount').textContent = professions.length;
                document.getElementById('fileSize').textContent = (generatedCode.length / 1024).toFixed(2) + ' KB';

                updateStatus('‚úì Palette mapping generated successfully!', 'success');
                downloadBtn.disabled = false;

            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                console.error(error);
            } finally {
                generateBtn.disabled = false;
            }
        }

        function generateJavaScriptCode(mappings) {
            const sortedPaletteIds = Object.keys(mappings).map(Number).sort((a, b) => a - b);

            let code = `/**\n`;
            code += ` * GW2 Skill Palette ID to Skill ID Mapping\n`;
            code += ` * Auto-generated on ${new Date().toISOString().split('T')[0]}\n`;
            code += ` * Total mappings: ${sortedPaletteIds.length}\n`;
            code += ` * \n`;
            code += ` * This mapping allows converting palette IDs (used in build templates)\n`;
            code += ` * to skill IDs (used by the GW2 API) without making additional API calls.\n`;
            code += ` */\n\n`;
            code += `(function(window) {\n`;
            code += `    'use strict';\n\n`;
            code += `    // Palette ID -> Skill ID mapping\n`;
            code += `    window.GW2_PALETTE_MAPPING = {\n`;

            // Group by ranges for better readability
            sortedPaletteIds.forEach((paletteId, index) => {
                const skillId = mappings[paletteId];
                const isLast = index === sortedPaletteIds.length - 1;
                code += `        ${paletteId}: ${skillId}${isLast ? '' : ','}\n`;
            });

            code += `    };\n\n`;
            code += `    // Export a function to resolve palette IDs\n`;
            code += `    window.resolvePaletteId = function(paletteId) {\n`;
            code += `        return window.GW2_PALETTE_MAPPING[paletteId] || null;\n`;
            code += `    };\n\n`;
            code += `    // Create reverse mapping (skill ID -> palette ID)\n`;
            code += `    const REVERSE_MAPPING = {};\n`;
            code += `    for (const paletteId in window.GW2_PALETTE_MAPPING) {\n`;
            code += `        const skillId = window.GW2_PALETTE_MAPPING[paletteId];\n`;
            code += `        // Some skill IDs may map to multiple palette IDs - keep the first one\n`;
            code += `        if (!REVERSE_MAPPING[skillId]) {\n`;
            code += `            REVERSE_MAPPING[skillId] = parseInt(paletteId);\n`;
            code += `        }\n`;
            code += `    }\n\n`;
            code += `    // Export function to get palette ID from skill ID\n`;
            code += `    window.getPaletteIdForSkill = function(skillId) {\n`;
            code += `        return REVERSE_MAPPING[skillId] || null;\n`;
            code += `    };\n\n`;
            code += `})(window);\n`;

            return code;
        }

        function downloadMapping() {
            const blob = new Blob([generatedCode], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'palette-mapping.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            updateStatus('‚úì File downloaded! Replace src/palette-mapping.js with the downloaded file.', 'success');
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(generatedCode).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy to clipboard: ' + err);
            });
        }
    </script>
</body>
</html>
